import React, { useState, useCallback, useEffect } from 'react';
import useScrollPersistence from '../clientModules/scrollRestoration';
import styles from './PlatformArchitecture.module.css';

const serviceGroups: { label: string; services: string[] }[] = [
    {
        label: 'Core Data Services',
        services: ['S3', 'Glue', 'Glue Data Quality', 'Glue DataBrew', 'Lake Formation', 'EventBridge', 'API Gateway', 'MSK', 'CloudTrail', 'VPC']
    },
    {
        label: 'Integration & MLOps',
        services: ['OpenSearch', 'pgVector', 'Embeddings', 'Feature Store', 'SageMaker', 'LLM Loader', 'Attack Sim', 'Prompt Orchestrator']
    },
    {
        label: 'Security & Identity',
        services: ['Lambda', 'Step Functions', 'Playbooks', 'Remediation Guardrails', 'IAM', 'Secrets Manager', 'Security Hub', 'GuardDuty', 'WAF', 'IAM Identity Center']
    },
    {
        label: 'Governance & Observability',
        services: ['Config', 'Detective', 'Budgets', 'Cost Explorer', 'CloudWatch', 'Control Tower', 'Benchmarks']
    }
];

const usageBullets: Record<string, string[]> = {
    'Data & Integration': [
        'Ingest once, govern always: KMS, tags, and LF enforce lineage and access.',
        'Event-driven patterns (EB/MSK) decouple producers and consumers safely.',
        'APIs and trails are private by default; network paths are explicit via VPC.'
    ],
    // Data Plane services
    'S3': [
        'Buckets instantiated via Proton & CDK constructs, parameterized per environment (dev → prod).',
        'Default guardrails: SSE-KMS encryption, block public access, access logging, and lifecycle policies tuned per env.',
        'Explicit naming and prefixing by domain; parameterized retention and lifecycle tiers (dev→prod).'
    ],
    'Glue': [
        'Crawlers scheduled per source; tables tagged for Lake Formation.',
        'ETL jobs enforced by schema; failures surface to metrics/alerts.',
        'Contracts-first catalogs drive downstream features and embedding shapes.'
    ],
    'Glue Data Quality': [
        'Data quality rules run per dataset; thresholds enforce promotion gates.',
        'Profiles tracked over time to catch drift and anomalies.',
        'Failures route to EventBridge for triage and remediation.'
    ],
    'Glue DataBrew': [
        'Quick profiling and visual transforms for exploratory pipelines.',
        'Recipes versioned; export back to Glue ETL for productionization.',
        'Used sparingly in prod; heavier use in dev for speed.'
    ],
    'Lake Formation': [
        'LF-tags map to domains/teams; grants managed via IaC only.',
        'Fine-grained permissions before any compute touches data.',
        'Auditable grants/Revokes; row/column filters ready when needed.'
    ],
    'EventBridge': [
        'Event patterns route findings/changes to Step Functions/Lambda.',
        'Dead-letter SQS for resiliency; retries with backoff.',
        'Schema registry optional; detail-type normalized for consumers.'
    ],
    'API Gateway': [
        'Private IAM-auth endpoints for control-plane hooks (no public surface by default).',
        'Stage variables and throttles are env-tuned.',
        'Access logs to CloudWatch with request IDs for traceability.'
    ],
    'MSK': [
        'Dev: external or disabled; Prod: MSK with per-domain topics + SSE.',
        'Producers enforce schemas; consumers idempotent with offset tracking.',
        'Topic naming with env suffix; partitioning sized by throughput.'
    ],
    'CloudTrail': [
        'Org trail into S3 (immutable via bucket policies); multi-account coverage.',
        'EventBridge rules fan-out high-value API events to workflows.',
        'Retention aligned with compliance; access via LF-governed tables.'
    ],
    'VPC': [
        'Private subnets and VPC endpoints for AWS services (no public egress).',
        'Security groups least-privilege; NACLs for coarse segmenting.',
        'Route tables explicitly defined; flow logs enabled to S3/CloudWatch.'
    ],
    'GuardDuty': [
        'Enabled across accounts; findings aggregated and deduped.',
        'EventBridge routes P1/P2 findings to response playbooks.',
        'Findings mirrored to storage for search and correlation.'
    ],
    'Intelligence & Simulation': [
        'Hybrid retrieval (OpenSearch + vectors) ensures both recall and precision.',
        'Generative simulation validates assumptions before automation acts.',
        'Features, models, and prompts are versioned and observable.'
    ],
    // Intelligence Core services
    'OpenSearch': [
        'Dev toggle off (cost save); Prod domain with encryption + fine-grained access.',
        'Indices per domain; ILM policies keep hot/warm storage efficient.',
        'Used for findings/logs search in hybrid with vectors for recall.'
    ],
    'pgVector': [
        'Postgres with pgvector; ANN search via <-> operator.',
        'Connection via env (container in dev, managed Postgres in higher envs).',
        'Migrations create tables; embedding dims/version stored with docs.'
    ],
    'Embeddings': [
        'Batch size + device configurable; CPU stub locally, GPU when available.',
        'Model ID + dim persisted for reproducibility.',
        'Backpressure + retries avoid hot-spotting during bulk loads.'
    ],
    'Feature Store': [
        'Versioned features with explicit schemas; drift surfaces to metrics.',
        'Backed by governed storage (S3/Glue); SM Feature Store optional.',
        'Feature contracts pin prompt inputs across model revisions.'
    ],
    'SageMaker': [
        'Optional managed endpoints; roles via ExecutionRoleArn (no secret anti-patterns).',
        'Autoscaling + instance types are env-gated; cost controls on.',
        'Local inference path exists to avoid costs in dev.'
    ],
    'GenAI + Simulation': [
        'Loader picks the right model per task (stub → 7B Q4).',
        'Attack sim generates multi‑step paths to pressure‑test controls.',
        'Orchestrator composes tools with policy + token budgets.'
    ],
    // GenAI + Simulation services
    'LLM Loader': [
        'Abstraction over stub and HF models; optional 4‑bit quantization.',
        'Device auto-detect (CUDA/CPU); graceful OOM guidance.',
        'Swappable without breaking retrieval/prompt contracts.'
    ],
    'Attack Sim': [
        'Generates realistic multi-stage scenarios to validate controls.',
        'Outputs tagged and fed into metrics and tuning loops.',
        'Safe by design: no destructive actions in lower envs.'
    ],
    'Prompt Orchestrator': [
        'Composes tools and prompts with policy and spend limits.',
        'Token budgets enforced per request; logs for audit.',
        'Reusable chains with guardrails and redaction where needed.'
    ],
    'Orchestration & Governance': [
        'State machines with retries/timeouts and human-in-the-loop stops.',
        'Budgets, WAF, and policy-as-code gate risky flows and costs.',
        'Security/Config/Detective provide posture and investigation signals.'
    ],
    // Autonomy & Orchestration services
    'Lambda': [
        'Idempotent functions with retries and DLQs (SQS).',
        'Least-privilege roles; inputs validated; outputs traced.',
        'Deployed via IaC with env-aware names and tags.'
    ],
    'Step Functions': [
        'Sagas with retries/timeouts and optional manual approvals.',
        'Per-step metrics + structured logs for investigations.',
        'Clear failure paths and reversible compensations.'
    ],
    'Playbooks': [
        'Runbooks as code: conditional steps + evaluation gates.',
        'Every change is auditable and designed to be undoable.',
        'Tied to findings and budgets to throttle risky flows.'
    ],
    'Remediation Guardrails': [
        'Budget/Config/Security posture required before action.',
        'Pre-flight checks ensure least-privilege + blast radius safe.',
        'Approvals or dry-runs in lower envs by default.'
    ],
    'IAM': [
        'Explicit managed policies; boundary/conditions enforce least privilege.',
        'Standardized tags and names for auditability.',
        'Cross-stack role outputs imported by consumers.'
    ],
    'Secrets Manager': [
        'Centralized secrets by env; ARNs injected via config.',
        'Tight-scoped retrieval in code; rotation policies where needed.',
        'No derived-secret anti-patterns; secrets never store ARNs.'
    ],
    'Governance + Observability': [
        'Cost + retention scale up in prod; tags everywhere.',
        'BEIR/MTEB + DQ become gates, not suggestions.',
        'Metrics close the loop to tune thresholds + embeddings.'
    ],
    // Governance + Observability services
    'Security Hub': [
        'Aggregated findings across accounts; filters drive priorities.',
        'EventBridge routes criticals to orchestrations.',
        'Posture trends tracked; exceptions documented.'
    ],
    'Config': [
        'Recorders on; rules enforce guardrails and conformance.',
        'Noncompliance triggers remediation playbooks.',
        'Retention tuned per env and compliance needs.'
    ],
    'Budgets': [
        'Monthly budgets with SNS/email alerts per env.',
        'Hard-stops for unsafe autonomy when thresholds trip.',
        'Tags drive chargeback/showback visibility.'
    ],
    'CloudWatch': [
        'Metrics and dashboards across ingestion/orchestration pipelines.',
        'Structured logs with correlation IDs wired from producers.',
        'Alarms with actionable runbooks and suppression windows.'
    ],
    'Benchmarks': [
        'MTEB/BEIR harness; artifacts committed to repo.',
        'Gated in prod; informative in dev/staging.',
        'Signals tune embeddings, rerankers, and thresholds.'
    ],
    'Detective': [
        'Findings and logs stitched into graphs to accelerate investigations.',
        'Pivot from entities to relationships to uncover root cause.',
        'Access controlled via roles; artifacts exported for correlation.'
    ],
    'WAF': [
        'Managed rule sets applied to public edges; custom rules for control endpoints.',
        'Used as an external kill-switch/safety-brake for autonomy.',
        'Metrics feed into budgets/policy to throttle risky flows.'
    ],
    'Cost Explorer': [
        'Spend visibility per env with tags; forecasts drive scaling decisions.',
        'Detect anomalies and attribute to services/workloads.',
        'Reports exported and surfaced alongside posture/quality.'
    ],
    'Control Tower': [
        'Landing zone with guardrails and audited account vending.',
        'Baseline controls ensure Config/CloudTrail are always on.',
        'Integrates with Security/Identity for consistent posture.'
    ],
    'IAM Identity Center': [
        'Workforce SSO with SCIM/SAML; groups map to least-privilege roles.',
        'Account/app assignments codified; no ad-hoc grants.',
        'Central audit of access with periodic reviews.'
    ],
};

const serviceToLayer: Record<string, string> = {
    'S3': 'Data & Integration', 'Glue': 'Data & Integration', 'Lake Formation': 'Data & Integration', 'EventBridge': 'Data & Integration', 'API Gateway': 'Data & Integration', 'MSK': 'Data & Integration', 'CloudTrail': 'Data & Integration', 'VPC': 'Data & Integration', 'Glue Data Quality': 'Data & Integration', 'Glue DataBrew': 'Data & Integration',
    'OpenSearch': 'Intelligence & Simulation', 'pgVector': 'Intelligence & Simulation', 'Embeddings': 'Intelligence & Simulation', 'Feature Store': 'Intelligence & Simulation', 'SageMaker': 'Intelligence & Simulation', 'LLM Loader': 'Intelligence & Simulation', 'Attack Sim': 'Intelligence & Simulation', 'Prompt Orchestrator': 'Intelligence & Simulation',
    'Lambda': 'Orchestration & Governance', 'Step Functions': 'Orchestration & Governance', 'Playbooks': 'Orchestration & Governance', 'Remediation Guardrails': 'Orchestration & Governance', 'IAM': 'Orchestration & Governance', 'Secrets Manager': 'Orchestration & Governance', 'Security Hub': 'Orchestration & Governance', 'GuardDuty': 'Orchestration & Governance', 'Config': 'Orchestration & Governance', 'Detective': 'Orchestration & Governance', 'WAF': 'Orchestration & Governance', 'Budgets': 'Orchestration & Governance', 'Cost Explorer': 'Orchestration & Governance', 'CloudWatch': 'Orchestration & Governance', 'Control Tower': 'Orchestration & Governance', 'IAM Identity Center': 'Orchestration & Governance', 'Benchmarks': 'Orchestration & Governance'
};

const fallbackBullets = [
    'Dev for speed; prod for scale (managed streaming, OpenSearch, GPU).',
    'Config, not code, flips retention, concurrency, and models.',
    'Benchmarks + DQ continuously sharpen embeddings and policy.'
];

const narrativeMap: Record<string, string[]> = {
    ...usageBullets,
    fallback: fallbackBullets,
};

export default function PlatformArchitecture({ heading }: { heading?: string }) {
    useScrollPersistence();
    const [selectedKey, setSelectedKey] = useState<string | null>('S3');
    const [enableTagOverflow, setEnableTagOverflow] = useState(false);

    const selectItem = useCallback((key: string) => {
        setSelectedKey(key);
    }, []);

    useEffect(() => {
        if (typeof window === 'undefined' || typeof window.matchMedia !== 'function') return;
        const mediaQuery = window.matchMedia('(max-width: 900px)');
        const sync = () => setEnableTagOverflow(mediaQuery.matches);

        sync();

        if (typeof mediaQuery.addEventListener === 'function') {
            mediaQuery.addEventListener('change', sync);
            return () => mediaQuery.removeEventListener('change', sync);
        }

        // Fallback for older browsers
        mediaQuery.addListener(sync);
        return () => mediaQuery.removeListener(sync);
    }, []);
    // ...existing logic and hooks...

    let selectedItem = selectedKey || 'fallback';
    if (!narrativeMap[selectedItem]) {
        const fallbackKey = serviceToLayer[selectedItem];
        if (fallbackKey && narrativeMap[fallbackKey]) {
            selectedItem = fallbackKey;
        } else {
            selectedItem = 'fallback';
        }
    }

    const introHeading = heading || 'Unified Security Data Plane on AWS';
    const introSubtitle = 'Deterministic pipelines · Immutable infra · Model governance';

    return (
        <div className="scArch scArch--transparent" style={{ paddingTop: 18 }}>
            <div className="scArchFrame">
                <section className={styles.architectureSection}>
                    <div className={styles.archIntro}>
                        <div className={styles.archLabel}>Architecture</div>
                        <h2 className={`scArchTitle ${styles.archTitle}`}>{introHeading}</h2>
                        <p className={`scArchSubtitle ${styles.archSubtitle}`}>{introSubtitle}</p>
                    </div>

                    <div className={styles.servicesCard}>
                        <div className={styles.archGrid}>
                            <div className={styles.servicesColumn}>
                                <div className={styles.cardGroup}>
                                    <p className={styles.archTagSubtitle}>
                                        Click a service to view its role in ShieldCraft’s platform.
                                    </p>
                                    <div
                                        className={`scArchTags ${styles.serviceGroups}`}
                                        style={{ scrollBehavior: 'smooth' }}
                                        data-condensed={enableTagOverflow ? 'true' : 'false'}
                                        tabIndex={enableTagOverflow ? 0 : undefined}
                                        aria-label="ShieldCraft service groups"
                                    >
                                        {serviceGroups.map(group => (
                                            <div key={group.label} className={styles.serviceGroup}>
                                                <div className={styles.serviceGroupLabel}>{group.label}</div>
                                                {group.services.map((tag) => (
                                                    <button
                                                        key={tag}
                                                        type="button"
                                                        className={`${styles.tagButton} ${selectedKey === tag ? styles.tagButtonActive : ''}`}
                                                        onClick={() => selectItem(tag)}
                                                    >
                                                        {tag}
                                                    </button>
                                                ))}
                                            </div>
                                        ))}
                                    </div>

                                    <div id="arch-narrative" className={`scArchDetailCard ${styles.archNarrative} ${styles.archBlockSpacing}`}>
                                        {narrativeMap[selectedItem]?.map((line, idx) => (
                                            <p key={idx}>{line}</p>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className={styles.detailColumn}>
                                <div className={`scArchPrinciples ${styles.principlesCard}`} role="complementary">
                                    <h4>Design principles</h4>
                                    <p><strong>Immutable infra</strong></p>
                                    <p><strong>Observable pipelines</strong></p>
                                    <p><strong>Verified deploys</strong></p>
                                </div>
                                <div className={styles.cardGroup}>
                                    <UsageEmbedded selectedKey={selectedKey} />
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    );
}

// Embedded usage details component
function UsageEmbedded({ selectedKey }: { selectedKey: string | null }) {
    const baseIntro = 'Instantiated via Proton + CDK, parameterized per environment (dev → prod), with guardrails baked in.';

    let key = selectedKey || '';
    let bullets: string[] = [];
    if (key) {
        if (usageBullets[key]) bullets = usageBullets[key];
        else if (serviceToLayer[key] && usageBullets[serviceToLayer[key]]) bullets = usageBullets[serviceToLayer[key]];
    }
    const showFallback = !key;

    return (
        <div className={`implBlock scArchSectionSpacing ${styles.usageBlockEmbedded} ${styles.archBlockSpacing}`} aria-live="polite">
            <div className={styles.usageHeading}>ShieldCraft Implementation</div>
            <ul className={styles.usageList}>
                {(showFallback ? fallbackBullets : bullets).map(line => (
                    <li key={line} className={styles.usageItem}>{line}</li>
                ))}
            </ul>
            <div className={styles.usageFooterMini}>{baseIntro}</div>
        </div>
    );
}
